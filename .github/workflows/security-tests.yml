name: Security E2E Tests

on:
  push:
    branches: [main, staging, dev]
  pull_request:
    branches: [main, staging, dev]
    paths:
      - 'electron/src/**'
      - 'test/e2e-security/**'
      - '.github/workflows/security-tests.yml'

jobs:
  security-tests:
    name: Security E2E Tests
    runs-on: ubuntu-latest
    timeout-minutes: 30

    steps:
      - name: Cancel Previous Runs
        uses: styfle/cancel-workflow-action@85880fa0301c86cca9da44039ee3bb12d3bedbfa # v0.12.1
        with:
          access_token: ${{github.token}}

      - name: Checkout repository
        uses: actions/checkout@692973e3d937129bcbf40652eb9f2f61becf3332 # v4.1.7
        with:
          fetch-depth: 2

      - name: Set up Node.js
        uses: actions/setup-node@1e60f620b9541d16bece96c5465dc8ee9832be0b # v4.0.3
        with:
          node-version: 18.x
          cache: 'yarn'
          cache-dependency-path: '**/yarn.lock'

      - name: Install dependencies
        run: yarn --immutable

      - name: Build Electron app
        run: yarn build:ts

      - name: Install security test dependencies
        run: |
          cd test/e2e-security
          yarn install

      - name: Cache Playwright browsers
        uses: actions/cache@v4
        id: playwright-cache
        with:
          path: ~/.cache/ms-playwright
          key: ${{ runner.os }}-playwright-${{ hashFiles('test/e2e-security/yarn.lock') }}

      - name: Install Playwright browsers
        if: steps.playwright-cache.outputs.cache-hit != 'true'
        run: |
          cd test/e2e-security
          yarn playwright install --with-deps

      - name: Set up virtual display
        run: |
          sudo apt-get update
          sudo apt-get install -y xvfb x11-utils
          # Start Xvfb and keep it running
          export DISPLAY=:99
          Xvfb :99 -ac -screen 0 1280x1024x24 > /dev/null 2>&1 &
          # Wait for Xvfb to be ready
          sleep 5
          echo "DISPLAY=:99" >> $GITHUB_ENV
          # Verify Xvfb is working
          xdpyinfo -display :99 | head -10 || echo "Warning: Could not verify X server"

      - name: Run Security E2E Tests
        working-directory: test/e2e-security
        env:
          DISPLAY: ':99'
          ELECTRON_DISABLE_SECURITY_WARNINGS: true
          ELECTRON_DISABLE_GPU: true
          ELECTRON_NO_ATTACH_CONSOLE: true
          ELECTRON_ENABLE_LOGGING: true
          NODE_ENV: test
          WIRE_FORCE_EXTERNAL_AUTH: false
          HEADLESS: true
        run: |
          echo "DISPLAY is set to: $DISPLAY"
          echo "Verifying X server is running..."
          xdpyinfo -display :99 || echo "Warning: xdpyinfo failed, but continuing..."

          echo "Running Security Exposure Tests..."
          yarn test:security:exposure

          echo "Running Security Validation Tests..."
          yarn test:security:validation

          echo "Running Security Regression Tests..."
          yarn test:security:regression

      - name: Upload Security Test Report
        if: always()
        uses: actions/upload-artifact@50769540e7f4bd5e21e526ee35c689e35e0d6874 # v4.4.0
        with:
          name: security-test-report
          path: test/e2e-security/security-test-report/
          retention-days: 30

      - name: Upload Test Results
        if: always()
        uses: actions/upload-artifact@50769540e7f4bd5e21e526ee35c689e35e0d6874 # v4.4.0
        with:
          name: security-test-results
          path: test/e2e-security/test-results/
          retention-days: 30

      - name: Comment PR with Security Test Results
        if: github.event_name == 'pull_request' && always()
        uses: actions/github-script@60a0d83039c74a4aee543508d2ffcb1c3799cdea # v7.0.1
        with:
          script: |
            const fs = require('fs');
            const path = require('path');

            try {
              const reportPath = 'test/e2e-security/security-test-report/summary.json';
              if (fs.existsSync(reportPath)) {
                const summary = JSON.parse(fs.readFileSync(reportPath, 'utf8'));
                
                const comment = `## üõ°Ô∏è Security Test Results
                
                **Context Isolation & Sandbox Validation**
                
                - **Total Tests**: ${summary.totalTests || 'N/A'}
                - **Passed**: ${summary.passed || 'N/A'} ‚úÖ
                - **Failed**: ${summary.failed || 'N/A'} ${summary.failed > 0 ? '‚ùå' : ''}
                - **Duration**: ${summary.duration || 'N/A'}ms
                
                **Security Validations**
                - Context Isolation: ${summary.contextIsolationVerified ? '‚úÖ Verified' : '‚ùå Failed'}
                - Sandbox Enforcement: ${summary.sandboxVerified ? '‚úÖ Verified' : '‚ùå Failed'}
                
                ${summary.failed > 0 ? '‚ö†Ô∏è **Security tests failed!** Please review the test results and ensure all security measures are properly implemented.' : 'üéâ **All security tests passed!** Context isolation and sandbox are working correctly.'}
                
                [View detailed report](https://github.com/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId})
                `;
                
                github.rest.issues.createComment({
                  issue_number: context.issue.number,
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  body: comment
                });
              }
            } catch (error) {
              console.log('Could not read test summary:', error);
            }
